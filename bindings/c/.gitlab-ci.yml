# GitLab CI/CD configuration for HEDL CMake builds

stages:
  - build
  - test
  - package

variables:
  CMAKE_BUILD_TYPE: Release
  GIT_SUBMODULE_STRATEGY: recursive

# ============================================================================
# Build templates
# ============================================================================

.build_template: &build_template
  stage: build
  before_script:
    - apt-get update
    - apt-get install -y cmake build-essential curl
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    - source $HOME/.cargo/env
  script:
    - cd bindings/c
    - mkdir build && cd build
    - cmake .. -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE} ${CMAKE_EXTRA_FLAGS}
    - cmake --build . -j$(nproc)
    - DESTDIR=${CI_PROJECT_DIR}/install cmake --install . --prefix /usr/local
  artifacts:
    paths:
      - install/
      - bindings/c/build/examples/
    expire_in: 1 week

# ============================================================================
# Linux builds
# ============================================================================

build:linux:gcc:
  <<: *build_template
  image: debian:bookworm
  variables:
    CMAKE_EXTRA_FLAGS: "-DCMAKE_C_COMPILER=gcc -DCMAKE_CXX_COMPILER=g++"

build:linux:clang:
  <<: *build_template
  image: debian:bookworm
  before_script:
    - apt-get update
    - apt-get install -y cmake build-essential clang curl
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    - source $HOME/.cargo/env
  variables:
    CMAKE_EXTRA_FLAGS: "-DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++"

build:ubuntu:
  <<: *build_template
  image: ubuntu:22.04

build:fedora:
  stage: build
  image: fedora:latest
  before_script:
    - dnf install -y cmake gcc gcc-c++ rust cargo
  script:
    - cd bindings/c
    - mkdir build && cd build
    - cmake .. -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE}
    - cmake --build . -j$(nproc)
    - DESTDIR=${CI_PROJECT_DIR}/install cmake --install . --prefix /usr/local
  artifacts:
    paths:
      - install/
      - bindings/c/build/examples/
    expire_in: 1 week

# ============================================================================
# Feature matrix
# ============================================================================

build:minimal:
  <<: *build_template
  image: debian:bookworm
  variables:
    CMAKE_EXTRA_FLAGS: >
      -DHEDL_FEATURE_JSON=OFF
      -DHEDL_FEATURE_YAML=OFF
      -DHEDL_FEATURE_XML=OFF
      -DHEDL_FEATURE_CSV=OFF
      -DHEDL_FEATURE_PARQUET=OFF
      -DHEDL_FEATURE_NEO4J=OFF

build:static:
  <<: *build_template
  image: debian:bookworm
  variables:
    CMAKE_EXTRA_FLAGS: "-DHEDL_BUILD_SHARED=OFF -DHEDL_BUILD_STATIC=ON"

build:debug:
  <<: *build_template
  image: debian:bookworm
  variables:
    CMAKE_BUILD_TYPE: Debug

# ============================================================================
# Tests
# ============================================================================

test:examples:
  stage: test
  image: debian:bookworm
  dependencies:
    - build:linux:gcc
  script:
    - cd bindings/c/build/examples
    - LD_LIBRARY_PATH=${CI_PROJECT_DIR}/install/usr/local/lib ./hedl_example_basic
    - LD_LIBRARY_PATH=${CI_PROJECT_DIR}/install/usr/local/lib ./hedl_example_convert
    - LD_LIBRARY_PATH=${CI_PROJECT_DIR}/install/usr/local/lib ./hedl_example_errors
    - LD_LIBRARY_PATH=${CI_PROJECT_DIR}/install/usr/local/lib ./hedl_example_cmake_integration

test:integration:
  stage: test
  image: debian:bookworm
  dependencies:
    - build:linux:gcc
  before_script:
    - apt-get update
    - apt-get install -y cmake build-essential
  script:
    # Install HEDL
    - cp -r install/usr/local/* /usr/local/
    - ldconfig

    # Create test project
    - mkdir -p /tmp/test_project
    - |
      cat > /tmp/test_project/CMakeLists.txt << 'EOF'
      cmake_minimum_required(VERSION 3.15)
      project(HedlIntegrationTest)
      find_package(HEDL REQUIRED)
      add_executable(test main.c)
      target_link_libraries(test PRIVATE HEDL::hedl)
      EOF
    - |
      cat > /tmp/test_project/main.c << 'EOF'
      #include <stdio.h>
      #include "hedl.h"
      int main(void) {
          const char* hedl = "%VERSION: 1.0\n---\ntest: true\n";
          HedlDocument* doc = NULL;
          if (hedl_parse(hedl, -1, 1, &doc) == HEDL_OK) {
              printf("Integration test: PASS\n");
              hedl_free_document(doc);
              return 0;
          }
          fprintf(stderr, "Integration test: FAIL\n");
          return 1;
      }
      EOF

    # Build and run
    - cd /tmp/test_project
    - mkdir build && cd build
    - cmake ..
    - cmake --build .
    - ./test

# ============================================================================
# Package
# ============================================================================

package:deb:
  stage: package
  image: debian:bookworm
  dependencies:
    - build:linux:gcc
  script:
    - apt-get update
    - apt-get install -y dpkg-dev
    - mkdir -p hedl-dev_1.0.0/DEBIAN
    - mkdir -p hedl-dev_1.0.0/usr
    - cp -r install/usr/local hedl-dev_1.0.0/usr/

    # Create control file
    - |
      cat > hedl-dev_1.0.0/DEBIAN/control << EOF
      Package: hedl-dev
      Version: 1.0.0
      Section: devel
      Priority: optional
      Architecture: amd64
      Maintainer: Dweve B.V. <opensource@dweve.com>
      Description: HEDL C/C++ development library
       Hierarchical Entity Data Language C bindings
      EOF

    - dpkg-deb --build hedl-dev_1.0.0
    - mv hedl-dev_1.0.0.deb hedl-dev_1.0.0_amd64.deb

  artifacts:
    paths:
      - hedl-dev_1.0.0_amd64.deb
    expire_in: 1 month

package:tarball:
  stage: package
  image: debian:bookworm
  dependencies:
    - build:linux:gcc
  script:
    - cd install/usr/local
    - tar czf ${CI_PROJECT_DIR}/hedl-1.0.0-linux-x86_64.tar.gz .
  artifacts:
    paths:
      - hedl-1.0.0-linux-x86_64.tar.gz
    expire_in: 1 month
